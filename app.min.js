
Modules.addCached("aea", "function Config(t){var n;n=this,this.fileNo=t,Config.f=new(require(\"FlashEEPROM\")),Config.f.endAddr=Config.f.addr+1024,this.writeCount=0,this.periodicSync()}function Led(t){this.pin=t,pinMode(this.pin,\"output\"),this.mode=\"turn-off\",this.onTime=1e3,this.offTime=1e3}function merge(t){var n,i,e,o,r,u;for(n=slice$.call(arguments,1),i=0,e=n.length;e>i;++i){o=n[i];for(r in o)try{if(!(o[r]instanceof Object))throw null;t[r]=merge(t[r],o[r])}catch(a){u=a,void 0!==o[r]?t[r]=o[r]:delete t[r]}}return t}function in$(t,n){for(var i=-1,e=n.length>>>0;++i<e;)if(t===n[i])return!0;return!1}var sleep,after,clearTimer,pack,unpack,repl,waitEvents,getWaitEvent,isWaiting,runWaitingEvent,waitFor,timeoutWaitFor,go,out$=\"undefined\"!=typeof exports&&exports||this,slice$=[].slice;out$.sleep=sleep=function(t,n){return setTimeout(n,t)},out$.after=after=sleep,out$.clearTimer=clearTimer=function(t){try{return clearInterval(t)}catch(n){}},out$.pack=pack=function(t){return JSON.stringify(t)},out$.unpack=unpack=function(t){var n,i;try{if(n=JSON.parse(t.trim()),void 0===n)throw null;return n}catch(e){throw i=e,console.log(\"Error on unpacking: \",i),console.log(\"Raw wire data: \",t),\"Error on unpacking\"}},out$.repl=repl={detach:function(){console.log(\"Disabling REPL console!\"),LoopbackA.setConsole()},attach:function(){ser.setConsole(),console.log(\"REPL console enabled!\")}},Config.prototype.flush=function(){console.log(\"flushing to eeprom...\"),this.write(this.ram)},Config.prototype.periodicSync=function(){var t;t=this,function n(i){return sleep(36e5,function(){return t.flush(),n(i)})}(function(){})},Config.prototype.write=function(t){this.writeCount++>10&&(Config.f.cleanup(),this.writeCount=0),Config.f.write(this.fileNo,pack(t)),this.ram=t},Config.prototype.read=function(){var t,n;try{return t=E.toString(Config.f.read(this.fileNo)),this.ram=unpack(t),this.ram}catch(i){return n=i,console.log(\"ERROR CONFIG READ(\"+this.fileNo+\"): \"+n+\", raw: \"+t)}},Led.prototype.turn=function(t){return this.mode=t?\"on\":\"off\",digitalWrite(this.pin,t)},Led.prototype.baseBlink=function(){var t;return t=this,\"blink\"!==this.mode?(this.mode=\"blink\",function n(i){return\"blink\"===t.mode&&digitalWrite(t.pin,!0),sleep(t.onTime,function(){return\"blink\"===t.mode&&digitalWrite(t.pin,!1),sleep(t.offTime,function(){return\"blink\"===t.mode?n(i):i()})})}(function(){return console.log(\"blink ended, mode: \",t.mode)})):void 0},Led.prototype.blink=function(){return this.onTime=1e3,this.offTime=1e3,this.baseBlink()},Led.prototype.attBlink=function(){return this.onTime=300,this.offTime=300,this.baseBlink()},Led.prototype.infoBlink=function(){return this.onTime=80,this.offTime=2e3,this.baseBlink()},Led.prototype.wink=function(t){var n;return null==t&&(t=50),n=this,n.mode=\"wink\",console.log(\"Winking.. : \",t),n.turn(!0),sleep(t,function(){return n.turn(!1)})},out$.merge=merge,out$.Config=Config,out$.Led=Led,waitEvents={},getWaitEvent=function(t){var n;return n=waitEvents[t],void 0===n&&(n={callbacks:[],run:!1,waiting:!1},waitEvents[t]=n),n},out$.isWaiting=isWaiting=function(t){var n;return n=waitEvents[t],null!=n?n.waiting:!1},runWaitingEvent=function(t,n){var i,e,o,r,u,a,l=[];if(i=getWaitEvent(t),i.waiting&&i.run){for(i.run=!1,i.waiting=!1,e=0,r=(o=i.callbacks).length;r>e;++e)u=o[e],a=null===n?\"timed-out\":\"has-event\",clearTimer(n),waitEvents[t]=void 0,l.push(u(a));return l}},out$.waitFor=waitFor=function(t,n){var i;i=getWaitEvent(t),in$(\"\"+n,function(){var t,n,e,o,r=[];for(t=0,o=(e=i.callbacks).length;o>t;++t)n=e[t],r.push(\"\"+n);return r}())||(i.callbacks=i.callbacks.concat([n])),i.waiting=!0,runWaitingEvent(t,null)},out$.timeoutWaitFor=timeoutWaitFor=function(t,n,i){var e,o;e=getWaitEvent(n),in$(\"\"+i,function(){var t,n,i,o,r=[];for(t=0,o=(i=e.callbacks).length;o>t;++t)n=i[t],r.push(\"\"+n);return r}())||(e.callbacks=e.callbacks.concat([i])),e.waiting=!0,o=after(t,function(){return e.run=!0,runWaitingEvent(n,null)}),runWaitingEvent(n,o)},out$.go=go=function(t){var n;n=getWaitEvent(t),n.run=!0,runWaitingEvent(t,\"normally-go\")};");
Modules.addCached("FlashEEPROM", "function FlashEEPROM(t,e){var r,a,h;if(this.flash=e?e:require(\"Flash\"),t)this.addr=t;else if(void 0!==this.flash.getFree)r=this.flash.getFree(),r.length&&(this.addr=r[0].addr);else{if(a=process.memory(),!a.flash_start||!a.flash_length)throw\"process.memory() didn't contain information about flash memory\";this.addr=a.flash_start+a.flash_length}if(h=this.flash.getPage(this.addr),!h)throw\"Couldn't find flash page\";this.addr=h.addr,this.endAddr=h.addr+h.length}FlashEEPROM.prototype.getAddr=function(t){for(var e,r=this.addr,a=this.flash.read(4,r),h=-1;255!=a[3]&&r<this.endAddr;)a[0]==t&&(h=r),e=a[1]|a[2]<<8,r+=e+7&-4,a=this.flash.read(4,r);return{addr:h,end:r}},FlashEEPROM.prototype.read=function(t){var e,r=this.getAddr(t).addr;return 0>r?void 0:(key=this.flash.read(4,r),e=key[1]|key[2]<<8,this.flash.read(e,r+4))},FlashEEPROM.prototype.readMem=function(t){var e,r=this.getAddr(t).addr;return 0>r?void 0:(key=this.flash.read(4,r),e=key[1]|key[2]<<8,E.memoryArea(r+4,e))},FlashEEPROM.prototype.readAll=function(){for(var t,e=[],r=this.addr,a=this.flash.read(4,r);255!=a[3]&&r<this.endAddr;)t=a[1]|a[2]<<8,t&&(e[a[0]]=this.flash.read(t,r+4)),r+=t+7&-4,a=this.flash.read(4,r);return e},FlashEEPROM.prototype._write=function(t,e,r){if(this.flash.write(new Uint8Array([e,r.length,r.length>>8,0]),t),t+=4,4!=r.length){var a=new Uint8Array(r.length+3&-4);a.set(r),r=a}return r.length&&this.flash.write(r,t),t+r.length},FlashEEPROM.prototype.write=function(t,e){var r,a,h;if(e=E.toUint8Array(e),r=this.getAddr(t),!(r.addr>=0&&(key=this.flash.read(4,r.addr),a=key[1]|key[2]<<8,h=this.flash.read(a,r.addr+4),h==e))){if(r.end+e.length+4>=this.endAddr&&(r.end=this.cleanup(),r.end+e.length+4>=this.endAddr))throw\"Not enough memory!\";this._write(r.end,t,e)}},FlashEEPROM.prototype.cleanup=function(){var t,e,r=this.readAll();this.flash.erasePage(this.addr),t=this.addr;for(e in r)void 0!==r[e]&&(t=this._write(t,e,r[e]));return t},FlashEEPROM.prototype.erase=function(){this.flash.erasePage(this.addr)},exports=FlashEEPROM;");
function LongPolling(n){var o;o=this,this.settings=n,this.http=require("http"),this.content={node:n.id},this.events={error:[],data:[],receive:[],connect:[],disconnect:[],code:[]}}var ref$,sleep,waitFor,timeoutWaitFor,go,isWaiting,merge,unpack,pack,repl,config,Wifi,connectToWifi,genRandomId,loadCode,onInit,slice$=[].slice;ref$=require("aea"),sleep=ref$.sleep,waitFor=ref$.waitFor,timeoutWaitFor=ref$.timeoutWaitFor,go=ref$.go,isWaiting=ref$.isWaiting,merge=ref$.merge,unpack=ref$.unpack,pack=ref$.pack,repl=ref$.repl,config=ref$.config,Wifi=require("Wifi"),connectToWifi=function(n){return function(){var o,e,t,r,i;try{if(o=config.read(setting.wifi),e=o.essid,void 0===e)throw null;t=o.passwd,r=o.health}catch(c){i=c,e="aea",t="084DA789BF",r=-1,console.log("Using default ESSID: ",e)}return function s(n){return Wifi.scan(function(o){var t,r,i;for(t=0,r=o.length;r>t;++t)if(i=o[t],console.log("Found ESSID: ",i.ssid),i.ssid===e)return n();return console.log("ESSID '{"+e+"}' not found, searching again..."),sleep(2e3,function(){return s(n)})})}(function(){return function o(n){return console.log("trying to connect to wifi..."),Wifi.connect(e,{password:t},function(e){var t;if(console.log("connected? err=",e,"info",Wifi.getIP()),null===e)try{return n()}catch(r){t=r,console.log("WTF:",t)}sleep(5e3,function(){return o(n)})})}(function(){return"function"==typeof n?n():void 0})})}(function(){})},genRandomId=function(n){return n||(n=3),Math.floor(Math.random()*Math.pow(10,n))},LongPolling.prototype.mkOpts=function(n,o){var e;return e={host:this.settings.host,port:this.settings.port,path:this.settings.path,method:this.settings.method,headers:{"Content-Type":"application/json","Content-Length":pack(n).length}},o&&(e=merge(e,o)),e},LongPolling.prototype.trigger=function(n){var o,e,t,r,i,c=[];for(o=slice$.call(arguments,1),e=0,i=(r=this.events[n]).length;i>e;++e)t=r[e],"function"==typeof t&&c.push(t.apply(this,o));return c},LongPolling.prototype.send=function(n,o){return this.sendRaw({data:n},o)},LongPolling.prototype.sendAck=function(n){return this.sendRaw({ack:"Mahmut"},n)},LongPolling.prototype.sendRaw=function(n,o){var e,t,r,i,c;return e=this,t=merge(n,this.content),r=this.mkOpts(t),console.log("--------------------"),i=genRandomId(3),console.log("New POST request: ",i),c=this.http.request(r,function(n){return n.on("data",function(n){var e;if(e=unpack(n),console.log("POST: "+i+" HTTP> ",e),console.log("post requestine data gelince : ",process.memory()),e.ack)try{o()}catch(t){}if(e.data)try{return o()}catch(t){}}),n.on("error",function(){return console.log("Error: "+i+" ... WTF")}),n.on("close",function(){return console.log("Request: "+i+" closed by server..")})}),c.on("error",function(n){return e.trigger("error",n,o),o(n.message)}),c.write(pack(t)),c.end(),console.log("post requesti acildiktan sonra : ",process.memory())},loadCode=void 0,LongPolling.prototype.sendGet=function(n,o){var e,t,r,i,c;return e=this,t=this.content,n=merge(n,{method:"GET",headers:null}),r=this.mkOpts(t,n),i=genRandomId(3),console.log("New GET request: "+i),c=this.http.get(r,function(n){return n.on("data",function(n){return console.log("GET: "+i+" have DATA: ",n,typeof n,n.length),loadCode=n,console.log("get requestine data gelince : ",process.memory()),go("call-error")})}),c.on("error",function(n){return console.log("GET: "+i+" have PROBLEM: ",n," type: ",typeof n),console.log("Error code: ",n.code),console.log("Error message : ",n.message),isWaiting("call-error")?go("call-error",n):"no response"===n.message?o("try-connect-again"):void 0}),console.log("get requesti acildiktan sonra : ",process.memory()),timeoutWaitFor(3e4,"call-error",function(n,e){return"has-event"===n?(console.log("Has event: ",e),o(e)):"timed-out"===n?(console.log("Timeout...."),o("timeout")):void 0})},LongPolling.prototype.connect=function(n){var o;return o=this,this.sendAck(function(e){return e?(console.log("Trying to connect again (2s)..."),sleep(1e3,function(){return o.connect(n)})):(console.log("Connect function run correctly.."),n(),function t(n){return console.log("Receiver is starting asyncronously.."),o.sendGet({path:"/receive"},function(o){return o?"try-connect-again"===o?(console.log("I have a problem. I must be connect again: ",o),t(n)):void 0:(console.log("I got data.. I am connecting again for new data: "),sleep(1e4,function(){return t(n)}))})}(function(){}))})},LongPolling.prototype.on=function(n,o){var e;return(e=this.events)[n]=e[n].concat(o)},onInit=function(){return connectToWifi(function(){var n,o;return n=new LongPolling({host:"192.168.2.107",id:"abc123",port:5656,path:"/send",method:"POST"}),o=n,o.on("receive",function(n){return console.log("I received following data: ",n)}),o.on("error",function(n){return console.log("COMM-ERR::: ",n.message)}),o.on("connect",function(n){return console.log("Connected to server!!! Server info: ",n)}),o.on("disconnect",function(){return console.log("Disconnected from server!")}),o.on("code",function(n){return console.log("Code is : ",n)}),n.connect(function(){return sleep(2e4,function(){})})})};
